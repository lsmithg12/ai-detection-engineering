# =============================================================================
# Blue Team Lab — ECS-to-Splunk Field Extraction
#
# Events from the lab simulator arrive as ECS JSON (e.g., event.code, process.name).
# These EVAL- transforms extract nested JSON fields into named Splunk fields at
# search time, making detection SPL searches work without `| spath` overhead.
#
# Covers: Sysmon EID 1,3,7,8,10,13 + WinEvent 4624
# =============================================================================

[sysmon]
KV_MODE = json
SHOULD_LINEMERGE = false
NO_BINARY_CHECK = true

# ── Core event fields ─────────────────────────────────────────────────────────
EVAL-EventCode = spath(_raw, "event.code")
EVAL-EventCategory = spath(_raw, "event.category")

# ── Process fields (EID 1, 8, 10) ────────────────────────────────────────────
EVAL-Image            = spath(_raw, "process.executable")
EVAL-process          = spath(_raw, "process.name")
EVAL-CommandLine      = spath(_raw, "process.command_line")
EVAL-ProcessId        = spath(_raw, "process.pid")
EVAL-ParentImage      = spath(_raw, "process.parent.executable")
EVAL-ParentCommandLine = spath(_raw, "process.parent.command_line")
EVAL-ParentProcessId  = spath(_raw, "process.parent.pid")

# ── Injection / process access fields (EID 8, 10) ────────────────────────────
EVAL-TargetImage      = spath(_raw, "winlog.event_data.TargetImage")
EVAL-GrantedAccess    = spath(_raw, "winlog.event_data.GrantedAccess")
EVAL-SourceImage      = spath(_raw, "winlog.event_data.SourceImage")
EVAL-StartAddress     = spath(_raw, "winlog.event_data.StartAddress")
EVAL-StartFunction    = spath(_raw, "winlog.event_data.StartFunction")
EVAL-StartModule      = spath(_raw, "winlog.event_data.StartModule")

# ── Network fields (EID 3) ────────────────────────────────────────────────────
EVAL-DestinationIp    = spath(_raw, "destination.ip")
EVAL-DestinationPort  = spath(_raw, "destination.port")
EVAL-SourceIp         = spath(_raw, "source.ip")
EVAL-SourcePort       = spath(_raw, "source.port")
EVAL-NetworkDirection = spath(_raw, "network.direction")

# ── File / image load fields (EID 7) ─────────────────────────────────────────
EVAL-ImageLoaded      = spath(_raw, "file.path")
EVAL-FileName         = spath(_raw, "file.name")
EVAL-Signed           = spath(_raw, "file.pe.original_file_name")

# ── Registry fields (EID 13) ─────────────────────────────────────────────────
EVAL-TargetObject     = spath(_raw, "registry.path")
EVAL-Details          = spath(_raw, "registry.value")
EVAL-EventType        = spath(_raw, "event.action")

# ── User / host fields (all events) ──────────────────────────────────────────
EVAL-user             = spath(_raw, "user.name")
EVAL-UserDomain       = spath(_raw, "user.domain")
EVAL-host             = spath(_raw, "host.name")
EVAL-OsPlatform       = spath(_raw, "host.os.platform")

# ── Simulation metadata ───────────────────────────────────────────────────────
EVAL-SimType          = spath(_raw, "_simulation.type")
EVAL-MitreTechnique   = spath(_raw, "_simulation.technique")
EVAL-SimLabel         = spath(_raw, "_simulation.label")

# ── CIM aliases (Splunk Common Information Model compatibility) ───────────────
FIELDALIAS-src_ip     = SourceIp AS src_ip
FIELDALIAS-dest_ip    = DestinationIp AS dest_ip
FIELDALIAS-dest_port  = DestinationPort AS dest_port


[simulation]
KV_MODE = json
SHOULD_LINEMERGE = false
NO_BINARY_CHECK = true

EVAL-EventCode    = spath(_raw, "event.code")
EVAL-Image        = spath(_raw, "process.executable")
EVAL-CommandLine  = spath(_raw, "process.command_line")
EVAL-TargetImage  = spath(_raw, "winlog.event_data.TargetImage")
EVAL-GrantedAccess = spath(_raw, "winlog.event_data.GrantedAccess")
EVAL-TargetObject = spath(_raw, "registry.path")
EVAL-Details      = spath(_raw, "registry.value")
EVAL-DestinationIp = spath(_raw, "destination.ip")
EVAL-DestinationPort = spath(_raw, "destination.port")
EVAL-user         = spath(_raw, "user.name")
EVAL-host         = spath(_raw, "host.name")
EVAL-SimType      = spath(_raw, "_simulation.type")
EVAL-MitreTechnique = spath(_raw, "_simulation.technique")
